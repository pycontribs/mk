---
name: release
on:
  release:
    types: [published]
jobs:
  pypi:
    name: Publish ${{ github.event.release.tag_name || '<testing>' }} to pypi.org
    environment: release
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
    steps:
      - uses: astral-sh/setup-uv@4959332f0f014c5280e7eac8b70c90cb574c9f9b # v6

      - name: Check out src from Git
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0 # needed by setuptools-scm
          submodules: true

      - name: Build dists
        run: uv build --all-packages

      - name: Run smoke tests for wheels
        run: uv run --isolated --no-project $(printf -- "--with %s " dist/*.whl) ./tools/smoke.sh

      - name: Run smoke tests for source distribution
        run: uv run --isolated --no-project $(printf -- "--with %s " dist/*.tar.gz) ./tools/smoke.sh

      - name: Attach dists to the release
        if: github.event_name == 'release'
        # cspell: ignore softprops
        uses: softprops/action-gh-release@72f2c25fcb47643c292f7107632f7a47c1df5cd8 # v2
        with:
          name: ${{ github.event.release.tag_name }}
          files: dist/*

      - name: Publish to pypi.org
        # "create" workflows run separately from "push" & "pull_request"
        if: github.event_name == 'release'
        run: uv publish --trusted-publishing always
